declare function print(s: string);

function main() {
    print("Starting Atomic Test...");

    // Create an array for shared data
    let arr = [0, 0, 0];
    
    // Test Atomic.add
    // arr[0] should become 10
    let old = std.atomic.add(arr, 0, 10);
    print("Atomic.add old value: " + old);
    print("arr[0] is now: " + arr[0]);
    
    // Test Atomic.load
    let val = std.atomic.load(arr, 0);
    print("Atomic.load value: " + val);
    
    // Test Atomic.sub
    // arr[0] should become 5
    std.atomic.sub(arr, 0, 5);
    print("After sub(5), arr[0]: " + arr[0]);
    
    // Test Atomic.store
    std.atomic.store(arr, 1, 100);
    print("After store(100) to index 1: " + arr[1]);
    
    // Test Atomic.and
    std.atomic.store(arr, 2, 0b1100); // 12
    let oldAnd = std.atomic.and(arr, 2, 0b1010); // 10
    print("Atomic.and old: " + oldAnd + ", new: " + arr[2]); // Expected new: 8 (1000)

    // Test Atomic.or
    std.atomic.store(arr, 2, 0b1000); // 8
    let oldOr = std.atomic.or(arr, 2, 0b0001); // 1
    print("Atomic.or old: " + oldOr + ", new: " + arr[2]); // Expected new: 9 (1001)

    // Test Atomic.xor
    std.atomic.store(arr, 2, 0b1111); // 15
    let oldXor = std.atomic.xor(arr, 2, 0b0011); // 3
    print("Atomic.xor old: " + oldXor + ", new: " + arr[2]); // Expected new: 12 (1100)

    // Test Atomic.xchg
    std.atomic.store(arr, 2, 100);
    let oldXchg = std.atomic.xchg(arr, 2, 200);
    print("Atomic.xchg old: " + oldXchg + ", new: " + arr[2]); // Expected old: 100, new: 200

    // Test Atomic.cmpxchg
    std.atomic.store(arr, 2, 200);
    let oldCmp = std.atomic.cmpxchg(arr, 2, 200, 300); // Success
    print("Atomic.cmpxchg (success) old: " + oldCmp + ", new: " + arr[2]); // Expected old: 200, new: 300
    
    let oldCmpFail = std.atomic.cmpxchg(arr, 2, 200, 400); // Fail (current is 300)
    print("Atomic.cmpxchg (fail) old: " + oldCmpFail + ", new: " + arr[2]); // Expected old: 300, new: 300

    // Test Wait/Notify
    // wait(addr, expected, timeout) -> 0=ok, 1=not_equal, 2=timed_out
    
    let res = std.atomic.wait(arr, 1, 100, 1000); // 1ms timeout
    print("Wait result (should be 2/timeout): " + res);
    
    let res2 = std.atomic.wait(arr, 1, 99, 1000); // Expected 99, but is 100 -> should be 1 (not-equal)
    print("Wait result (should be 1/not-equal): " + res2);
}
