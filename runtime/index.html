<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OmniScript Runtime Playground</title>
    <script src="https://unpkg.com/wabt@1.0.32/index.js"></script>
    <script src="omni_runtime.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; }
        .container { display: flex; gap: 20px; }
        textarea { width: 100%; height: 300px; font-family: monospace; }
        #output { background: #f0f0f0; padding: 10px; min-height: 100px; }
        button { padding: 10px 20px; cursor: pointer; font-weight: bold; }
        
        /* Test Area */
        #test-area { border: 1px solid #ccc; padding: 20px; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>OmniScript Runtime (WAT Loader)</h1>
    
    <div id="test-area">
        <h3>DOM Test Area</h3>
        <div id="status">Waiting...</div>
        <button id="actionBtn">Click Me (Controlled by Wasm)</button>
    </div>

    <div class="container">
        <div style="flex: 1">
            <h3>WAT Code (Paste generated .wat here)</h3>
            <button onclick="loadDomTest()" style="margin-bottom: 10px;">Load Generated dom_test.wat</button>
            <textarea id="watInput">
(module
  ;; Imports from OmniRuntime
  (import "env" "print" (func $print (param i32)))
  (import "env" "document_getElementById" (func $document_getElementById (param i32) (result i32)))
  (import "env" "element_setInnerText" (func $element_setInnerText (param i32) (param i32)))

  ;; Memory export
  (memory (export "memory") 1)
  
  ;; Data segment for strings
  (data (i32.const 0) "status\00")
  (data (i32.const 10) "Hello from Wasm!\00")

  (func $main (export "main") (result i32)
    (local $el i32)
    
    ;; print("status")
    i32.const 0
    call $print

    ;; el = document.getElementById("status")
    i32.const 0
    call $document_getElementById
    local.set $el

    ;; if (el != 0) element.innerText = "Hello from Wasm!"
    local.get $el
    if
      local.get $el
      i32.const 10
      call $element_setInnerText
    end

    i32.const 0
  )
)
            </textarea>
            <br><br>
            <button onclick="runWasm()">Run Wasm</button>
        </div>
        <div style="flex: 1">
            <h3>Console Output</h3>
            <div id="output"></div>
        </div>
    </div>

    <script>
        const outputDiv = document.getElementById('output');
        
        function logToPage(msg) {
            const line = document.createElement('div');
            line.textContent = msg;
            outputDiv.appendChild(line);
            console.log(msg);
        }

        async function loadDomTest() {
            try {
                const response = await fetch('../output/dom_test.wat');
                if (!response.ok) throw new Error('Failed to load output/dom_test.wat');
                const text = await response.text();
                document.getElementById('watInput').value = text;
                logToPage("[INFO] Loaded output/dom_test.wat");
            } catch (e) {
                logToPage(`[ERROR] ${e.message}`);
            }
        }

        async function runWasm() {
            outputDiv.innerHTML = '';
            const watContent = document.getElementById('watInput').value;

            try {
                const wabt = await WabtModule();
                const module = wabt.parseWat('example.wat', watContent);
                const binary = module.toBinary({});
                
                // Initialize OmniRuntime
                const runtime = new OmniRuntime();
                
                // Get imports
                const imports = runtime.getImports();

                const wasmModule = await WebAssembly.instantiate(binary.buffer, imports);
                const instance = wasmModule.instance;
                
                // Link memory to runtime
                runtime.setMemory(instance.exports.memory);
                runtime.exports = instance.exports;

                const { main } = instance.exports;
                
                if (main) {
                    logToPage("[INFO] Running main...");
                    const result = main();
                    logToPage(`[RESULT] Main returned: ${result}`);
                } else {
                    logToPage(`[INFO] No 'main' function exported.`);
                }
            } catch (e) {
                logToPage(`[ERROR] ${e.message}`);
                console.error(e);
            }
        }
    </script>
</body>
</html>
